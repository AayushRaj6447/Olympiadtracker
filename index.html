<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Olympiad Tracker — Stable UI + Export</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body { font-family: Arial, sans-serif; padding: 18px; background:#f4f6fb; color:#111 }
  .card { max-width:1000px; margin:auto; background:#fff; padding:16px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.06) }
  h1 { margin-top:0 }
  .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:10px }
  select, input[type="number"], input[type="text"] { padding:6px; font-size:14px }
  .grid { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px }
  .btn { padding:8px 12px; border:1px solid #cfcfcf; border-radius:6px; background:#fff; cursor:pointer; text-align:center; min-width:110px }
  .btn.active { background:#2e8b57; color:white; border-color:#2e8b57 }
  .section-select { padding:6px; }
  .controls { margin-top:12px; display:flex; gap:8px; flex-wrap:wrap }
  .summary { margin-top:18px }
  table.summary-table { width:100%; border-collapse:collapse; margin-top:8px; font-size:13px }
  table.summary-table th, table.summary-table td { border:1px solid #ddd; padding:6px; text-align:center }
  .small { font-size:13px; color:#444; margin-top:6px }
</style>
</head>
<body>
  <div class="card">
    <h1>Olympiad Tracker — Stable UI + Export</h1>

    <div class="row">
      <label for="classSelect">Class</label>
      <select id="classSelect"></select>

      <button id="prevBtn" class="btn">← Previous</button>
      <span id="studentId" style="font-weight:700; margin:0 8px;">I_1</span>
      <button id="nextBtn" class="btn">Next →</button>
    </div>

    <div class="row">
      <label>Section</label>
      <select id="sectionSelect" class="section-select">
        <option value="">(none)</option>
        <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option>
      </select>

      <label>Roll</label>
      <input id="rollInput" type="text" placeholder="roll (optional)">

      <button id="clearBtn" class="btn">Clear Student</button>
      <button id="resetBtn" class="btn">Reset All</button>
      <button id="exportBtn" class="btn">Export (XLSX/CSV)</button>
    </div>

    <hr>

    <h3>Exams (₹150 each)</h3>
    <div id="examButtons" class="grid"></div>

    <h3 style="margin-top:14px">Books (₹100 each — Reasoning ₹250)</h3>
    <div id="bookButtons" class="grid"></div>

    <div class="summary">
      <h3>Live Summary — Class-wise counts & revenue</h3>
      <div id="summaryContainer"></div>
    </div>

    <div class="small">
      Notes: No keyboard shortcuts in this stable build. Use the buttons to toggle exams/books, change section/roll, then navigate Next/Previous. Data saved locally in your browser.
    </div>
  </div>

  <!-- XLSX CDN for nicer export; fallback to CSV if not available -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
  (function(){
    // --- CONFIG ---
    const SUBJECTS = ["GK","English","Science","Maths","Computer","Social Studies","Hindi","Reasoning"];
    const MAX_STUDENTS = 250;
    const EXAM_FEE = 150;
    const BOOK_PRICE_DEFAULT = 100;
    const BOOK_PRICE_REASONING = 250;
    const STORAGE_KEY = 'olympiadDataStableV1';

    // --- STATE ---
    let currentClass = 'I';
    let currentIndex = 1;
    let data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); // data keyed by id "I_1"

    // --- DOM ---
    const classSelect = document.getElementById('classSelect');
    const studentIdSpan = document.getElementById('studentId');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const examButtonsDiv = document.getElementById('examButtons');
    const bookButtonsDiv = document.getElementById('bookButtons');
    const sectionSelect = document.getElementById('sectionSelect');
    const rollInput = document.getElementById('rollInput');
    const clearBtnEl = document.getElementById('clearBtn');
    const resetBtnEl = document.getElementById('resetBtn');
    const exportBtnEl = document.getElementById('exportBtn');
    const summaryContainer = document.getElementById('summaryContainer');

    const ROMAN = ['I','II','III','IV','V','VI','VII','VIII','IX','X'];

    // --- INIT UI ---
    function init(){
      // populate classes
      ROMAN.forEach(r => {
        const opt = document.createElement('option'); opt.value = r; opt.textContent = r;
        classSelect.appendChild(opt);
      });
      classSelect.value = currentClass;
      classSelect.addEventListener('change', ()=>{ currentClass = classSelect.value; currentIndex = 1; renderCurrent(); });

      // build exam/book buttons
      SUBJECTS.forEach((s, i) => {
        const eb = document.createElement('button');
        eb.className = 'btn';
        eb.textContent = s;
        eb.dataset.sub = s;
        eb.addEventListener('click', ()=> toggleExam(s));
        examButtonsDiv.appendChild(eb);

        const bb = document.createElement('button');
        bb.className = 'btn';
        bb.textContent = s;
        bb.dataset.sub = s;
        bb.addEventListener('click', ()=> toggleBook(s));
        bookButtonsDiv.appendChild(bb);
      });

      prevBtn.addEventListener('click', ()=> { if(currentIndex>1){ currentIndex--; renderCurrent(); }});
      nextBtn.addEventListener('click', ()=> { if(currentIndex < MAX_STUDENTS){ currentIndex++; renderCurrent(); }});

      sectionSelect.addEventListener('change', ()=> { saveCurrent(); renderSummary(); });
      rollInput.addEventListener('input', ()=> { saveCurrent(); });

      clearBtnEl.addEventListener('click', clearCurrent);
      resetBtnEl.addEventListener('click', ()=>{ if(confirm('Reset ALL data?')){ data = {}; saveAll(); renderCurrent(); renderSummary(); }});
      exportBtnEl.addEventListener('click', exportAll);

      renderCurrent();
      renderSummary();
    }

    // --- DATA HELPERS ---
    function idFor(className, idx){
      return `${className}_${idx}`;
    }
    function ensureRecord(id){
      if(!data[id]){
        data[id] = { cls: currentClass, idx: currentIndex, exams: [], books: [], section: '', roll: '' };
      }
      return data[id];
    }
    function saveAll(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }

    // --- UI ACTIONS ---
    function renderCurrent(){
      // update student id display
      studentIdSpan.textContent = `${currentClass}_${currentIndex}`;
      // load record if present
      const id = idFor(currentClass, currentIndex);
      const rec = data[id] || { exams: [], books: [], section: '', roll: '' };

      // set button states
      const examBtns = examButtonsDiv.children;
      for(let i=0;i<examBtns.length;i++){
        const sub = examBtns[i].dataset.sub;
        examBtns[i].classList.toggle('active', rec.exams && rec.exams.includes(sub));
      }
      const bookBtns = bookButtonsDiv.children;
      for(let i=0;i<bookBtns.length;i++){
        const sub = bookBtns[i].dataset.sub;
        bookBtns[i].classList.toggle('active', rec.books && rec.books.includes(sub));
      }

      // set section and roll
      sectionSelect.value = rec.section || '';
      rollInput.value = rec.roll || '';

      // save (ensure record created when user toggles later)
      saveAll();
      renderSummary();
    }

    function toggleExam(subject){
      const id = idFor(currentClass, currentIndex);
      const rec = ensureRecord(id);
      const p = rec.exams.indexOf(subject);
      if(p === -1) rec.exams.push(subject); else rec.exams.splice(p,1);
      saveAll(); renderCurrent(); renderSummary();
    }

    function toggleBook(subject){
      const id = idFor(currentClass, currentIndex);
      const rec = ensureRecord(id);
      const p = rec.books.indexOf(subject);
      if(p === -1) rec.books.push(subject); else rec.books.splice(p,1);
      saveAll(); renderCurrent(); renderSummary();
    }

    function saveCurrent(){
      const id = idFor(currentClass, currentIndex);
      const rec = ensureRecord(id);
      rec.section = sectionSelect.value || '';
      rec.roll = (rollInput.value || '').toString().trim();
      saveAll();
      renderSummary();
    }

    function clearCurrent(){
      const id = idFor(currentClass, currentIndex);
      if(data[id]) delete data[id];
      saveAll();
      renderCurrent();
      renderSummary();
    }

    // --- SUMMARY ---
    function renderSummary(){
      // build class list I..X
      const classes = ROMAN;
      // header
      let html = '<table class="summary-table"><tr><th>Class</th>';
      SUBJECTS.forEach(s => { html += `<th>${s} Exam</th><th>${s} Book</th>`; });
      html += '<th>Exam ₹</th><th>Book ₹</th><th>Total ₹</th></tr>';

      let grandExam=0, grandBook=0, grandTotal=0;
      classes.forEach(cls => {
        const examCount = SUBJECTS.map(()=>0);
        const bookCount = SUBJECTS.map(()=>0);
        let examRevenue = 0, bookRevenue = 0;
        // scan all records
        for(const key in data){
          if(!data.hasOwnProperty(key)) continue;
          const rec = data[key];
          if(!rec || rec.cls !== cls) continue;
          // exams
          (rec.exams || []).forEach(sub => {
            const idx = SUBJECTS.indexOf(sub);
            if(idx >= 0){ examCount[idx]++; examRevenue += EXAM_FEE; }
          });
          // books
          (rec.books || []).forEach(sub => {
            const idx = SUBJECTS.indexOf(sub);
            if(idx >= 0){
              bookCount[idx]++;
              bookRevenue += (sub === 'Reasoning' ? BOOK_PRICE_REASONING : BOOK_PRICE_DEFAULT);
            }
          });
        }

        const classTotal = examRevenue + bookRevenue;
        grandExam += examRevenue; grandBook += bookRevenue; grandTotal += classTotal;

        html += `<tr><td>${cls}</td>`;
        for(let i=0;i<SUBJECTS.length;i++){
          html += `<td>${examCount[i]}</td><td>${bookCount[i]}</td>`;
        }
        html += `<td>₹${examRevenue}</td><td>₹${bookRevenue}</td><td>₹${classTotal}</td></tr>`;
      });

      // grand totals row
      html += `<tr style="font-weight:700"><td>Grand Total</td>`;
      for(let i=0;i<SUBJECTS.length;i++) html += `<td></td><td></td>`;
      html += `<td>₹${grandExam}</td><td>₹${grandBook}</td><td>₹${grandTotal}</td></tr>`;
      html += '</table>';
      summaryContainer.innerHTML = html;
    }

    // --- EXPORT ---
    function exportAll(){
      // Build Students sheet rows
      const header = ["Class","StudentID","Section","Roll","ExamList","BookList","ExamCost","BookCost","Total"];
      SUBJECTS.forEach(s => { header.push(`${s} (Exam)`); header.push(`${s} (Book)`); });
      const rows = [header];

      // iterate sorted by class and student id
      const sortedKeys = Object.keys(data).sort((a,b)=>{
        // sort by class order then index numeric
        const [ca, ia] = a.split('_'); const [cb, ib] = b.split('_');
        const caIdx = ROMAN.indexOf(ca); const cbIdx = ROMAN.indexOf(cb);
        if(caIdx !== cbIdx) return caIdx - cbIdx;
        return Number(ia) - Number(ib);
      });

      sortedKeys.forEach(key => {
        const rec = data[key];
        if(!rec) return;
        const [cls, idx] = key.split('_');
        const exams = rec.exams || [];
        const books = rec.books || [];
        const examCost = (exams.length || 0) * EXAM_FEE;
        const bookCost = (books.reduce((sum, s) => sum + (s === 'Reasoning' ? BOOK_PRICE_REASONING : BOOK_PRICE_DEFAULT), 0) || 0);
        const total = examCost + bookCost;
        const row = [rec.cls || cls, key, rec.section || '', rec.roll || '', exams.join(', '), books.join(', '), examCost, bookCost, total];
        SUBJECTS.forEach(s => { row.push(exams.includes(s) ? 1 : 0); row.push(books.includes(s) ? 1 : 0); });
        rows.push(row);
      });

      // Build Class Summary
      const classHeader = ["Class","Exam ₹","Book ₹","Total ₹"];
      SUBJECTS.forEach(s => { classHeader.push(`${s} (Exam)`); classHeader.push(`${s} (Book)`); });
      const classRows = [classHeader];

      ROMAN.forEach(cls => {
        const examCount = SUBJECTS.map(()=>0);
        const bookCount = SUBJECTS.map(()=>0);
        let examRevenue = 0, bookRevenue = 0;
        for(const key in data){
          const rec = data[key];
          if(!rec || rec.cls !== cls) continue;
          (rec.exams || []).forEach(sub => {
            const idx = SUBJECTS.indexOf(sub);
            if(idx >= 0){ examCount[idx]++; examRevenue += EXAM_FEE; }
          });
          (rec.books || []).forEach(sub => {
            const idx = SUBJECTS.indexOf(sub);
            if(idx >= 0){ bookCount[idx]++; bookRevenue += (sub === 'Reasoning' ? BOOK_PRICE_REASONING : BOOK_PRICE_DEFAULT); }
          });
        }
        const row = [cls, examRevenue, bookRevenue, examRevenue + bookRevenue];
        SUBJECTS.forEach((_,i)=>{ row.push(examCount[i]); row.push(bookCount[i]); });
        classRows.push(row);
      });

      // Try XLSX
      if(window.XLSX){
        const wb = XLSX.utils.book_new();
        const ws1 = XLSX.utils.aoa_to_sheet(rows);
        const ws2 = XLSX.utils.aoa_to_sheet(classRows);
        XLSX.utils.book_append_sheet(wb, ws1, 'Students');
        XLSX.utils.book_append_sheet(wb, ws2, 'ClassSummary');
        XLSX.writeFile(wb, 'olympiad_export.xlsx');
      } else {
        // fallback: download two CSVs
        downloadCSV(rows, 'olympiad_students.csv');
        downloadCSV(classRows, 'olympiad_class_summary.csv');
        alert('XLSX library not available — exported CSV files for Students & ClassSummary.');
      }
    }
    function downloadCSV(rows, filename){
      const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click();
      document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    // --- BOILERPLATE to keep consistent class info when saving ---
    // When toggling, ensure record has cls and idx stored
    function ensureRecord(id){
      if(!data[id]){
        // id pattern like 'I_1'
        const [cls, idx] = id.split('_');
        data[id] = { cls: cls, idx: Number(idx), exams: [], books: [], section: '', roll: '' };
      }
      return data[id];
    }
    // override previous ensureRecord used in toggleExam/toggleBook earlier
    // But our earlier ensureRecord had different signature; fix references:
    // We'll use idFor to build id.
    function idFor(className, index){ return `${className}_${index}`; }

    // Re-define the toggle/save functions to use the canonical ensureRecord above
    function toggleExam(subject){
      const id = idFor(currentClass, currentIndex);
      const rec = ensureRecord(id);
      const p = rec.exams.indexOf(subject);
      if(p === -1) rec.exams.push(subject); else rec.exams.splice(p,1);
      saveAll(); renderCurrent(); renderSummary();
    }
    function toggleBook(subject){
      const id = idFor(currentClass, currentIndex);
      const rec = ensureRecord(id);
      const p = rec.books.indexOf(subject);
      if(p === -1) rec.books.push(subject); else rec.books.splice(p,1);
      saveAll(); renderCurrent(); renderSummary();
    }
    function saveCurrent(){
      const id = idFor(currentClass, currentIndex);
      const rec = ensureRecord(id);
      rec.section = sectionSelect.value || '';
      rec.roll = (rollInput.value || '').toString().trim();
      saveAll();
      renderSummary();
    }
    // attach saveCurrent to UI change
    sectionSelect.addEventListener('change', saveCurrent);
    rollInput.addEventListener('input', saveCurrent);

    // Start
    init();

    // Expose some functions to buttons already wired:
    window.toggleExam = toggleExam;
    window.toggleBook = toggleBook;
    window.clearCurrent = function(){ clearCurrent(); };
    window.exportAll = exportAll;
    window.saveAll = saveAll;
    window.renderCurrent = renderCurrent;
    window.renderSummary = renderSummary;

    // Ensure save when navigating
    prevBtn.addEventListener('click', saveAll);
    nextBtn.addEventListener('click', saveAll);

  })();
  </script>
</body>
</html>