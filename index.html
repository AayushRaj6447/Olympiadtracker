<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Olympiad Tracker — Exams & Books</title>
<style>
  body { font-family: Arial, sans-serif; margin: 18px; background:#f4f6fb; color:#111 }
  .card { max-width:1100px; margin: auto; background:#fff; padding:16px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.06) }
  h1 { margin:0 0 12px 0; font-size:20px }
  .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:10px }
  label { font-weight:600; }
  select, input[type="number"] { padding:6px; font-size:14px }
  .grid { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px }
  .btn { padding:8px 10px; border:1px solid #cfcfcf; border-radius:6px; background:#fff; cursor:pointer; min-width:100px; text-align:center }
  .btn.active { background:#2e8b57; color:#fff; border-color:#2e8b57 }
  .section-btn.active { background:#1565c0; color:#fff; border-color:#1565c0 }
  .controls { margin-top:12px; display:flex; gap:8px; flex-wrap:wrap }
  .summary { margin-top:18px; }
  table.summary-table { width:100%; border-collapse:collapse; margin-top:8px; font-size:13px }
  table.summary-table th, table.summary-table td { border:1px solid #ddd; padding:6px; text-align:center }
  .legend { margin-top:8px; font-size:13px; color:#444 }
  .small { font-size:12px; color:#666 }
</style>
</head>
<body>
  <div class="card">
    <h1>Olympiad Tracker — Exams & Books</h1>

    <div class="row">
      <label for="classSelect">Class</label>
      <select id="classSelect"></select>

      <label for="rollInput">Roll No</label>
      <input id="rollInput" type="number" min="1" max="250" placeholder="(focus to type roll#)" />

      <label>Section</label>
      <div id="sectionButtons" class="grid"></div>
    </div>

    <div>
      <h3 style="margin:8px 0 4px 0">Exams (₹150 each) — keys: <strong>1..8</strong></h3>
      <div id="examButtons" class="grid"></div>
    </div>

    <div>
      <h3 style="margin:8px 0 4px 0">Books (₹100 each — Reasoning ₹250) — keys: <strong>Q W E R T Y U I</strong></h3>
      <div id="bookButtons" class="grid"></div>
    </div>

    <div class="controls">
      <button id="prevBtn" class="btn">← Previous</button>
      <button id="nextBtn" class="btn">Next →</button>
      <button id="clearBtn" class="btn">Clear Current</button>
      <button id="resetBtn" class="btn">Reset All</button>
      <button id="exportBtn" class="btn">Export Excel/CSV</button>
    </div>

    <div class="legend small">
      Shortcuts: <strong>1–8</strong> toggle Exams (when Roll input not focused), <strong>Q W E R T Y U I</strong> toggle Books, <strong>Z X C V B</strong> select Sections A–E. Use ← / → for Prev/Next. Roll number typing works when Roll field is focused.
    </div>

    <div class="summary" id="summaryArea">
      <h3>Live Summary</h3>
      <div id="summaryTableContainer"></div>
    </div>
  </div>

  <!-- XLSX library (if available online) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
  (function(){
    // CONFIG
    const SUBJECTS = ["GK","English","Science","Maths","Computer","Social Studies","Hindi","Reasoning"];
    const MAX_STUDENTS = 250;
    const EXAM_FEE = 150;
    const BOOK_PRICE_DEFAULT = 100;
    const BOOK_PRICE_REASONING = 250;

    // DOM refs
    const classSelect = document.getElementById('classSelect');
    const rollInput = document.getElementById('rollInput');
    const examButtonsDiv = document.getElementById('examButtons');
    const bookButtonsDiv = document.getElementById('bookButtons');
    const sectionButtonsDiv = document.getElementById('sectionButtons');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const clearBtn = document.getElementById('clearBtn');
    const resetBtn = document.getElementById('resetBtn');
    const exportBtn = document.getElementById('exportBtn');
    const summaryTableContainer = document.getElementById('summaryTableContainer');

    // data: data[classNumber][studentNumber] = { exams:[], books:[], section:'A'..'E', roll: '123' }
    let data = JSON.parse(localStorage.getItem('olympiadData') || '{}');

    // state
    let currentClass = 1;
    let currentStudent = 1;

    // initialize UI
    function initUI(){
      // class options
      for(let c=1;c<=10;c++){
        const opt = document.createElement('option');
        opt.value = c; opt.textContent = 'Class ' + c;
        classSelect.appendChild(opt);
      }
      classSelect.value = currentClass;
      classSelect.addEventListener('change', ()=>{
        currentClass = Number(classSelect.value);
        currentStudent = 1;
        loadStudent();
        renderSummary();
      });

      // section buttons A..E (shortcut map Z X C V B)
      ['A','B','C','D','E'].forEach(s=>{
        const b = document.createElement('button');
        b.className = 'btn section-btn';
        b.textContent = s;
        b.dataset.section = s;
        b.addEventListener('click', ()=>{ selectSection(s); });
        sectionButtonsDiv.appendChild(b);
      });

      // exam buttons 1..8
      SUBJECTS.forEach((sub,i)=>{
        const b = document.createElement('button');
        b.className = 'btn';
        b.textContent = `${sub} (${i+1})`;
        b.dataset.sub = sub; b.dataset.idx = i;
        b.addEventListener('click', ()=> toggleExam(i) );
        examButtonsDiv.appendChild(b);
      });

      // book buttons Q-W-E-R-T-Y-U-I mapping
      SUBJECTS.forEach((sub,i)=>{
        const b = document.createElement('button');
        b.className = 'btn';
        b.textContent = sub;
        b.dataset.sub = sub; b.dataset.idx = i;
        b.addEventListener('click', ()=> toggleBook(i) );
        bookButtonsDiv.appendChild(b);
      });

      // nav buttons
      prevBtn.addEventListener('click', ()=> { if(currentStudent>1){ currentStudent--; loadStudent(); } });
      nextBtn.addEventListener('click', ()=> { if(currentStudent<MAX_STUDENTS){ currentStudent++; loadStudent(); } });
      clearBtn.addEventListener('click', clearCurrent);
      resetBtn.addEventListener('click', ()=>{ if(confirm('Reset ALL data?')){ data = {}; saveData(); loadStudent(); renderSummary(); }});
      exportBtn.addEventListener('click', exportAll);

      // roll input saves on change
      rollInput.addEventListener('input', ()=> {
        const rec = getRecord(currentClass, currentStudent, true);
        rec.roll = rollInput.value.trim();
        saveData();
      });

      // keyboard handling
      window.addEventListener('keydown', handleKey);

      // initial load
      loadStudent();
      renderSummary();
    }

    // helpers
    function getRecord(cls, stu, createIfMissing = false){
      if(!data[cls]){
        if(!createIfMissing) return null;
        data[cls] = {};
      }
      if(!data[cls][stu]){
        if(!createIfMissing) return null;
        data[cls][stu] = { exams: [], books: [], section: null, roll: "" };
      }
      return data[cls][stu];
    }

    function saveData(){ localStorage.setItem('olympiadData', JSON.stringify(data)); }

    // toggle functions
    function toggleExam(index){
      const rec = getRecord(currentClass, currentStudent, true);
      const subject = SUBJECTS[index];
      const pos = rec.exams.indexOf(subject);
      if(pos === -1) rec.exams.push(subject); else rec.exams.splice(pos,1);
      saveData(); loadStudent(); renderSummary();
    }
    function toggleBook(index){
      const rec = getRecord(currentClass, currentStudent, true);
      const subject = SUBJECTS[index];
      const pos = rec.books.indexOf(subject);
      if(pos === -1) rec.books.push(subject); else rec.books.splice(pos,1);
      saveData(); loadStudent(); renderSummary();
    }
    function selectSection(s){
      const rec = getRecord(currentClass, currentStudent, true);
      rec.section = s;
      saveData(); loadStudent(); renderSummary();
    }

    function clearCurrent(){
      if(data[currentClass] && data[currentClass][currentStudent]){
        delete data[currentClass][currentStudent];
        saveData();
      }
      loadStudent();
      renderSummary();
    }

    function loadStudent(){
      // clear UI toggles
      document.querySelectorAll('#examButtons .btn').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('#bookButtons .btn').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('#sectionButtons .section-btn').forEach(b=>b.classList.remove('active'));
      rollInput.value = '';

      // fill if exists
      const rec = getRecord(currentClass, currentStudent, false);
      if(rec){
        // set exam buttons
        rec.exams.forEach(sub=>{
          const btn = Array.from(examButtonsDiv.children).find(x => x.dataset.sub === sub);
          if(btn) btn.classList.add('active');
        });
        // set book buttons
        rec.books.forEach(sub=>{
          const btn = Array.from(bookButtonsDiv.children).find(x => x.dataset.sub === sub);
          if(btn) btn.classList.add('active');
        });
        // section
        if(rec.section){
          const secBtn = Array.from(sectionButtonsDiv.children).find(x => x.dataset.section === rec.section);
          if(secBtn) secBtn.classList.add('active');
        }
        // roll
        if(rec.roll) rollInput.value = rec.roll;
      }
      updatePosition();
    }

    function updatePosition(){
      // show current student position near controls (append if not present)
      let pos = document.getElementById('positionDisplay');
      if(!pos){
        pos = document.createElement('div'); pos.id = 'positionDisplay'; pos.style.marginTop = '8px';
        document.querySelector('.card').insertBefore(pos, summaryTableContainer.parentNode);
      }
      pos.textContent = `Class ${currentClass} • Student ${currentStudent}`;
    }

    // keyboard handler
    function handleKey(e){
      const active = document.activeElement;
      const activeTag = active && active.tagName ? active.tagName.toUpperCase() : null;

      // If typing in any input (except rollInput) or textarea, don't intercept
      if(activeTag === 'INPUT' && active !== rollInput) return;
      if(activeTag === 'TEXTAREA') return;

      // Section keys: Z X C V B => A B C D E
      const secMap = { 'Z':'A', 'X':'B', 'C':'C', 'V':'D', 'B':'E' };
      const keyUpper = e.key.toUpperCase();

      // Arrow keys navigation
      if(e.key === 'ArrowRight'){ e.preventDefault(); if(currentStudent < MAX_STUDENTS) { currentStudent++; loadStudent(); } return; }
      if(e.key === 'ArrowLeft'){ e.preventDefault(); if(currentStudent > 1) { currentStudent--; loadStudent(); } return; }

      // If rollInput is focused: let typing and backspace behave normally (user types roll)
      if(document.activeElement === rollInput) return; // avoid hijacking keys while user types roll

      // Number keys 1..8 -> toggle exams (only when rollInput is NOT focused)
      if(/^[1-8]$/.test(e.key)){
        e.preventDefault();
        const idx = Number(e.key) - 1;
        toggleExam(idx);
        return;
      }

      // Book keys Q W E R T Y U I
      const bookOrder = ['Q','W','E','R','T','Y','U','I'];
      const bidx = bookOrder.indexOf(keyUpper);
      if(bidx >= 0){
        e.preventDefault();
        toggleBook(bidx);
        return;
      }

      // Section keys
      if(secMap[keyUpper]){
        e.preventDefault();
        selectSection(secMap[keyUpper]);
        return;
      }

      // If user types digits while rollInput is not focused, we decided to interpret them as exam toggles above.
      // So nothing else to do.
    }

    // Render summary: class-wise table with exam/book counts and revenue
    function renderSummary(){
      const classes = Object.keys(data).map(Number).sort((a,b)=>a-b);
      if(classes.length === 0){
        summaryTableContainer.innerHTML = '<div class="small">No data yet.</div>';
        return;
      }

      // table header
      let html = '<table class="summary-table"><tr><th>Class</th>';
      SUBJECTS.forEach(s => { html += `<th>${s} (Exam)</th><th>${s} (Book)</th>`; });
      html += '<th>Exam ₹</th><th>Book ₹</th><th>Total ₹</th></tr>';

      let grandExam = 0, grandBook = 0, grandTotal = 0;

      for(const cls of classes){
        const examCount = Array(SUBJECTS.length).fill(0);
        const bookCount = Array(SUBJECTS.length).fill(0);
        let examRevenue = 0, bookRevenue = 0;

        for(const stu of Object.keys(data[cls])){
          const rec = data[cls][stu];
          const recExams = Array.isArray(rec.exams) ? rec.exams : [];
          const recBooks = Array.isArray(rec.books) ? rec.books : [];

          recExams.forEach(sub => {
            const i = SUBJECTS.indexOf(sub);
            if(i >= 0){ examCount[i]++; examRevenue += EXAM_FEE; }
          });
          recBooks.forEach(sub => {
            const i = SUBJECTS.indexOf(sub);
            if(i >= 0){ bookCount[i]++; bookRevenue += (sub === 'Reasoning' ? BOOK_PRICE_REASONING : BOOK_PRICE_DEFAULT); }
          });
        }

        const classTotal = examRevenue + bookRevenue;
        grandExam += examRevenue; grandBook += bookRevenue; grandTotal += classTotal;

        html += `<tr><td>Class ${cls}</td>`;
        for(let i=0;i<SUBJECTS.length;i++){
          html += `<td>${examCount[i]}</td><td>${bookCount[i]}</td>`;
        }
        html += `<td>₹${examRevenue}</td><td>₹${bookRevenue}</td><td>₹${classTotal}</td></tr>`;
      }

      // grand row
      html += `<tr style="font-weight:700"><td>Grand Total</td>`;
      for(let i=0;i<SUBJECTS.length;i++) html += `<td></td><td></td>`;
      html += `<td>₹${grandExam}</td><td>₹${grandBook}</td><td>₹${grandTotal}</td></tr>`;

      html += '</table>';
      summaryTableContainer.innerHTML = html;
    }

    // Export all data:
    // Sheet1: Students (detailed); Sheet2: ClassSummary
    function exportAll(){
      const rowsStudents = [];
      // header
      const header = ["Class","StudentNumber","Section","Roll","ExamList","BookList","ExamCost","BookCost","Total"];
      SUBJECTS.forEach(s => { header.push(`${s} (Exam)`); header.push(`${s} (Book)`); });
      rowsStudents.push(header);

      const classes = Object.keys(data).map(Number).sort((a,b)=>a-b);
      for(const cls of classes){
        const students = Object.keys(data[cls]).map(Number).sort((a,b)=>a-b);
        for(const stu of students){
          const rec = data[cls][stu];
          const exams = Array.isArray(rec.exams) ? rec.exams : [];
          const books = Array.isArray(rec.books) ? rec.books : [];
          const examCost = (exams.length || 0) * EXAM_FEE;
          const bookCost = (books.reduce((sum, sub) => sum + (sub === 'Reasoning' ? BOOK_PRICE_REASONING : BOOK_PRICE_DEFAULT), 0) || 0);
          const total = examCost + bookCost;
          const row = [cls, stu, rec.section || '', rec.roll || '', exams.join(', '), books.join(', '), examCost, bookCost, total];
          SUBJECTS.forEach(s => { row.push(exams.includes(s) ? 1 : 0); row.push(books.includes(s) ? 1 : 0); });
          rowsStudents.push(row);
        }
      }

      // Class summary sheet
      const rowsClass = [];
      const headerC = ["Class","Total Exam ₹","Total Book ₹","Total ₹"];
      // add per-subject counts
      SUBJECTS.forEach(s => { headerC.push(`${s} (Exam)`); headerC.push(`${s} (Book)`); });
      rowsClass.push(headerC);

      for(const cls of classes){
        const examCount = Array(SUBJECTS.length).fill(0);
        const bookCount = Array(SUBJECTS.length).fill(0);
        let examRevenue = 0, bookRevenue = 0;
        for(const stu of Object.keys(data[cls])){
          const rec = data[cls][stu];
          const recExams = Array.isArray(rec.exams) ? rec.exams : [];
          const recBooks = Array.isArray(rec.books) ? rec.books : [];
          recExams.forEach(sub => { const i = SUBJECTS.indexOf(sub); if(i>=0){ examCount[i]++; examRevenue += EXAM_FEE; }});
          recBooks.forEach(sub => { const i = SUBJECTS.indexOf(sub); if(i>=0){ bookCount[i]++; bookRevenue += (sub === 'Reasoning' ? BOOK_PRICE_REASONING : BOOK_PRICE_DEFAULT); }});
        }
        const row = [cls, examRevenue, bookRevenue, examRevenue + bookRevenue];
        SUBJECTS.forEach((_,i)=>{ row.push(examCount[i]); row.push(bookCount[i]); });
        rowsClass.push(row);
      }

      // Try to use XLSX lib if loaded
      if(window.XLSX){
        const wb = XLSX.utils.book_new();
        const ws1 = XLSX.utils.aoa_to_sheet(rowsStudents);
        const ws2 = XLSX.utils.aoa_to_sheet(rowsClass);
        XLSX.utils.book_append_sheet(wb, ws1, "Students");
        XLSX.utils.book_append_sheet(wb, ws2, "ClassSummary");
        XLSX.writeFile(wb, "olympiad_export.xlsx");
      } else {
        // fallback: produce CSV for students only, and a second csv for class summary (download zipped is complex), so offer students csv.
        const csv = rowsStudents.map(r => r.map(cell=>`"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'olympiad_students.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert('XLSX library not available: exported CSV of student data. To export .xlsx, enable internet or include the XLSX library.');
      }
    }

    // Start
    initUI();

    // small safety: ensure loadStudent exists in this scope (it does)
    // end of IIFE
  })();
  </script>
</body>
</html>