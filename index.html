<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Olympiad Tracker — Fixed Live Feed + Export</title>
<style>
  body { font-family: Arial, sans-serif; margin:18px; background:#f4f7fc; color:#111 }
  .card { max-width:1150px; margin:auto; background:#fff; padding:16px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.06) }
  h1 { margin:0 0 12px 0 }
  .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:10px }
  label { font-weight:600 }
  select, input[type="number"] { padding:6px; font-size:14px }
  .grid { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px }
  .btn { padding:8px 12px; border:1px solid #cfcfcf; border-radius:6px; background:#fff; cursor:pointer; min-width:110px; text-align:center }
  .btn.active { background:#2e8b57; color:#fff; border-color:#2e8b57 }
  .section-btn.active { background:#1565c0; color:#fff; border-color:#1565c0 }
  .controls { margin-top:12px; display:flex; gap:8px; flex-wrap:wrap }
  .summary-box { margin-top:18px }
  table.summary-table { width:100%; border-collapse:collapse; margin-top:8px; font-size:13px }
  table.summary-table th, table.summary-table td { border:1px solid #ddd; padding:6px; text-align:center }
  .small { font-size:12px; color:#444; margin-top:6px }
  .note { color:#666; font-size:13px; margin-top:8px }
</style>
</head>
<body>
  <div class="card">
    <h1>Olympiad Tracker — Exams & Books</h1>

    <div class="row">
      <label for="classSelect">Class</label>
      <select id="classSelect"></select>

      <label for="rollInput">Roll No</label>
      <input id="rollInput" type="number" min="1" max="250" placeholder="focus to type roll number" />

      <label>Section</label>
      <div id="sectionButtons" class="grid"></div>
    </div>

    <div>
      <h3>Exams (₹150 each) — Keys: 1..8</h3>
      <div id="examButtons" class="grid"></div>
    </div>

    <div>
      <h3>Books (₹100 each — Reasoning ₹250) — Keys: Q W E R T Y U I</h3>
      <div id="bookButtons" class="grid"></div>
    </div>

    <div class="controls">
      <button id="prevBtn" class="btn">← Prev</button>
      <button id="nextBtn" class="btn">Next →</button>
      <button id="clearBtn" class="btn">Clear Current</button>
      <button id="resetBtn" class="btn">Reset All</button>
      <button id="exportBtn" class="btn">Export (XLSX/CSV)</button>
    </div>

    <div class="note">
      Shortcuts (when Roll field NOT focused): 1–8 = Exam; Q W E R T Y U I = Book; Z X C V B = Section A–E; ← / → = Prev/Next. 
      To type roll numbers, click the Roll No field (or focus it) and type.
    </div>

    <div class="summary-box">
      <h3>Live Summary (class-wise subject distribution)</h3>
      <div id="summaryTableContainer"></div>
    </div>
  </div>

  <!-- XLSX lib (online); code will fallback to CSV if not available -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
  (function(){
    // CONFIG
    const SUBJECTS = ["GK","English","Science","Maths","Computer","Social Studies","Hindi","Reasoning"];
    const MAX_STUDENTS = 250;
    const EXAM_FEE = 150;
    const BOOK_PRICE_DEFAULT = 100;
    const BOOK_PRICE_REASONING = 250;

    // DOM
    const classSelect = document.getElementById('classSelect');
    const rollInput = document.getElementById('rollInput');
    const examButtonsDiv = document.getElementById('examButtons');
    const bookButtonsDiv = document.getElementById('bookButtons');
    const sectionButtonsDiv = document.getElementById('sectionButtons');
    const summaryTableContainer = document.getElementById('summaryTableContainer');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const clearBtn = document.getElementById('clearBtn');
    const resetBtn = document.getElementById('resetBtn');
    const exportBtn = document.getElementById('exportBtn');

    // data: data[classNumber][studentNumber] = { exams:[], books:[], section:'A'..'E', roll: '123' }
    let data = JSON.parse(localStorage.getItem('olympiadData') || '{}');

    // state
    let currentClass = 1;
    let currentStudent = 1;

    // initialize UI
    function init(){
      // class options 1..10
      for(let c=1;c<=10;c++){
        const opt = document.createElement('option');
        opt.value = c; opt.textContent = 'Class ' + c;
        classSelect.appendChild(opt);
      }
      classSelect.value = currentClass;
      classSelect.addEventListener('change', ()=>{
        currentClass = Number(classSelect.value);
        currentStudent = 1;
        loadStudent();
        renderSummary();
      });

      // section buttons: Z X C V B => A..E
      ['A','B','C','D','E'].forEach(s=>{
        const b = document.createElement('button');
        b.className = 'btn section-btn';
        b.textContent = s;
        b.dataset.section = s;
        b.addEventListener('click', ()=> { selectSection(s); });
        sectionButtonsDiv.appendChild(b);
      });

      // exam buttons 1..8
      SUBJECTS.forEach((sub,i)=>{
        const b = document.createElement('button');
        b.className = 'btn';
        b.textContent = `${sub} (${i+1})`;
        b.dataset.sub = sub; b.dataset.idx = i;
        b.addEventListener('click', ()=> toggleExam(i) );
        examButtonsDiv.appendChild(b);
      });

      // book buttons Q W E R T Y U I
      SUBJECTS.forEach((sub,i)=>{
        const b = document.createElement('button');
        b.className = 'btn';
        b.textContent = sub;
        b.dataset.sub = sub; b.dataset.idx = i;
        b.addEventListener('click', ()=> toggleBook(i) );
        bookButtonsDiv.appendChild(b);
      });

      // nav buttons
      prevBtn.addEventListener('click', ()=> { if(currentStudent>1){ currentStudent--; loadStudent(); } });
      nextBtn.addEventListener('click', ()=> { if(currentStudent<MAX_STUDENTS){ currentStudent++; loadStudent(); } });
      clearBtn.addEventListener('click', clearCurrent);
      resetBtn.addEventListener('click', ()=>{ if(confirm('Reset ALL data?')){ data = {}; saveData(); loadStudent(); renderSummary(); }});
      exportBtn.addEventListener('click', exportAll);

      // roll input saves on change
      rollInput.addEventListener('input', ()=> {
        const rec = getRecord(currentClass, currentStudent, true);
        rec.roll = rollInput.value.trim();
        saveData();
      });

      // keyboard events
      window.addEventListener('keydown', handleKey);

      // initial
      loadStudent();
      renderSummary();
    }

    // data helpers
    function getRecord(cls, stu, createIfMissing = false){
      if(!data[cls]){
        if(!createIfMissing) return null;
        data[cls] = {};
      }
      if(!data[cls][stu]){
        if(!createIfMissing) return null;
        data[cls][stu] = { exams: [], books: [], section: null, roll: "" };
      }
      return data[cls][stu];
    }
    function saveData(){ localStorage.setItem('olympiadData', JSON.stringify(data)); }

    // toggles
    function toggleExam(idx){
      const rec = getRecord(currentClass, currentStudent, true);
      const sub = SUBJECTS[idx];
      const p = rec.exams.indexOf(sub);
      if(p === -1) rec.exams.push(sub); else rec.exams.splice(p,1);
      saveData(); loadStudent(); renderSummary();
    }
    function toggleBook(idx){
      const rec = getRecord(currentClass, currentStudent, true);
      const sub = SUBJECTS[idx];
      const p = rec.books.indexOf(sub);
      if(p === -1) rec.books.push(sub); else rec.books.splice(p,1);
      saveData(); loadStudent(); renderSummary();
    }
    function selectSection(s){
      const rec = getRecord(currentClass, currentStudent, true);
      rec.section = s;
      saveData(); loadStudent(); renderSummary();
    }

    function clearCurrent(){
      if(data[currentClass] && data[currentClass][currentStudent]){
        delete data[currentClass][currentStudent];
        saveData();
      }
      loadStudent();
      renderSummary();
    }

    // load current student into UI
    function loadStudent(){
      // clear active states
      document.querySelectorAll('#examButtons .btn').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('#bookButtons .btn').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('#sectionButtons .section-btn').forEach(b=>b.classList.remove('active'));
      rollInput.value = '';

      const rec = getRecord(currentClass, currentStudent, false);
      if(rec){
        // exams
        rec.exams.forEach(sub=>{
          const btn = Array.from(examButtonsDiv.children).find(x => x.dataset.sub === sub);
          if(btn) btn.classList.add('active');
        });
        // books
        rec.books.forEach(sub=>{
          const btn = Array.from(bookButtonsDiv.children).find(x => x.dataset.sub === sub);
          if(btn) btn.classList.add('active');
        });
        // section
        if(rec.section){
          const secBtn = Array.from(sectionButtonsDiv.children).find(x => x.dataset.section === rec.section);
          if(secBtn) secBtn.classList.add('active');
        }
        // roll
        if(rec.roll) rollInput.value = rec.roll;
      }
      updatePosition();
    }

    function updatePosition(){
      let pos = document.getElementById('positionDisplay');
      if(!pos){
        pos = document.createElement('div'); pos.id = 'positionDisplay'; pos.style.marginTop='8px';
        document.querySelector('.card').insertBefore(pos, summaryTableContainer.parentNode);
      }
      pos.textContent = `Class ${currentClass} • Student ${currentStudent}`;
    }

    // keyboard handler
    function handleKey(e){
      // if some input other than rollInput is focused, don't hijack
      const active = document.activeElement;
      const activeTag = active && active.tagName ? active.tagName.toUpperCase() : null;
      if(activeTag === 'INPUT' && active !== rollInput) return;
      if(activeTag === 'TEXTAREA') return;

      const key = e.key;
      const keyUpper = key.toUpperCase();

      // Arrow navigation
      if(key === 'ArrowRight'){ e.preventDefault(); if(currentStudent<MAX_STUDENTS){ currentStudent++; loadStudent(); } return; }
      if(key === 'ArrowLeft'){ e.preventDefault(); if(currentStudent>1){ currentStudent--; loadStudent(); } return; }

      // If rollInput is focused, let typing happen for roll number
      if(document.activeElement === rollInput) return;

      // Number keys 1..8 -> Exams
      if(/^[1-8]$/.test(key)){
        e.preventDefault();
        const idx = Number(key)-1;
        toggleExam(idx);
        return;
      }

      // Book keys Q W E R T Y U I
      const bookOrder = ['Q','W','E','R','T','Y','U','I'];
      const bidx = bookOrder.indexOf(keyUpper);
      if(bidx >= 0){
        e.preventDefault();
        toggleBook(bidx);
        return;
      }

      // Section keys Z X C V B -> A B C D E
      const sectionMap = { 'Z':'A', 'X':'B', 'C':'C', 'V':'D', 'B':'E' };
      if(sectionMap[keyUpper]){
        e.preventDefault();
        selectSection(sectionMap[keyUpper]);
        return;
      }

      // Backspace / Delete handled normally when rollInput focused; when not focused ignore
    }

    // render summary: class-wise per-subject counts & money
    function renderSummary(){
      const classes = Object.keys(data).map(Number).sort((a,b)=>a-b);
      if(classes.length === 0){
        summaryTableContainer.innerHTML = '<div class="small">No data yet.</div>';
        return;
      }

      let html = '<table class="summary-table"><tr><th>Class</th>';
      SUBJECTS.forEach(s => { html += `<th>${s} (Exam)</th><th>${s} (Book)</th>`; });
      html += '<th>Exam ₹</th><th>Book ₹</th><th>Total ₹</th></tr>';

      let grandExam=0, grandBook=0, grandTotal=0;
      for(const cls of classes){
        const examCount = Array(SUBJECTS.length).fill(0);
        const bookCount = Array(SUBJECTS.length).fill(0);
        let examRevenue=0, bookRevenue=0;

        for(const stu of Object.keys(data[cls])){
          const rec = data[cls][stu];
          const recExams = Array.isArray(rec.exams) ? rec.exams : [];
          const recBooks = Array.isArray(rec.books) ? rec.books : [];

          recExams.forEach(sub => {
            const i = SUBJECTS.indexOf(sub);
            if(i>=0){ examCount[i]++; examRevenue += EXAM_FEE; }
          });
          recBooks.forEach(sub => {
            const i = SUBJECTS.indexOf(sub);
            if(i>=0){ bookCount[i]++; bookRevenue += (sub === 'Reasoning' ? BOOK_PRICE_REASONING : BOOK_PRICE_DEFAULT); }
          });
        }

        const classTotal = examRevenue + bookRevenue;
        grandExam += examRevenue; grandBook += bookRevenue; grandTotal += classTotal;

        html += `<tr><td>Class ${cls}</td>`;
        for(let i=0;i<SUBJECTS.length;i++){
          html += `<td>${examCount[i]}</td><td>${bookCount[i]}</td>`;
        }
        html += `<td>₹${examRevenue}</td><td>₹${bookRevenue}</td><td>₹${classTotal}</td></tr>`;
      }

      html += `<tr style="font-weight:700"><td>Grand Total</td>`;
      for(let i=0;i<SUBJECTS.length;i++){ html += `<td></td><td></td>`; }
      html += `<td>₹${grandExam}</td><td>₹${grandBook}</td><td>₹${grandTotal}</td></tr>`;
      html += '</table>';

      summaryTableContainer.innerHTML = html;
    }

    // export: XLSX (2 sheets) if library exists, else CSV fallback (students then class summary)
    function exportAll(){
      // prepare rows Students
      const header = ["Class","StudentNumber","Section","Roll","ExamList","BookList","ExamCost","BookCost","Total"];
      SUBJECTS.forEach(s => { header.push(`${s} (Exam)`); header.push(`${s} (Book)`); });
      const studentRows = [header];

      const classes = Object.keys(data).map(Number).sort((a,b)=>a-b);
      for(const cls of classes){
        const students = Object.keys(data[cls]).map(Number).sort((a,b)=>a-b);
        for(const stu of students){
          const rec = data[cls][stu];
          const exams = Array.isArray(rec.exams) ? rec.exams : [];
          const books = Array.isArray(rec.books) ? rec.books : [];
          const examCost = (exams.length || 0) * EXAM_FEE;
          const bookCost = (books.reduce((sum, sub) => sum + (sub === 'Reasoning' ? BOOK_PRICE_REASONING : BOOK_PRICE_DEFAULT), 0) || 0);
          const total = examCost + bookCost;
          const row = [cls, stu, rec.section || '', rec.roll || '', exams.join(', '), books.join(', '), examCost, bookCost, total];
          SUBJECTS.forEach(s => { row.push(exams.includes(s) ? 1 : 0); row.push(books.includes(s) ? 1 : 0); });
          studentRows.push(row);
        }
      }

      // prepare class summary rows
      const classHeader = ["Class","Exam ₹","Book ₹","Total ₹"];
      SUBJECTS.forEach(s => { classHeader.push(`${s} (Exam)`); classHeader.push(`${s} (Book)`); });
      const classRows = [classHeader];
      for(const cls of classes){
        const examCount = Array(SUBJECTS.length).fill(0);
        const bookCount = Array(SUBJECTS.length).fill(0);
        let examRevenue=0, bookRevenue=0;
        for(const stu of Object.keys(data[cls])){
          const rec = data[cls][stu];
          (rec.exams || []).forEach(sub => { const i=SUBJECTS.indexOf(sub); if(i>=0){ examCount[i]++; examRevenue+=EXAM_FEE; }});
          (rec.books || []).forEach(sub => { const i=SUBJECTS.indexOf(sub); if(i>=0){ bookCount[i]++; bookRevenue += (sub==='Reasoning'?BOOK_PRICE_REASONING:BOOK_PRICE_DEFAULT);}});
        }
        const r = [cls, examRevenue, bookRevenue, examRevenue+bookRevenue];
        for(let i=0;i<SUBJECTS.length;i++){ r.push(examCount[i]); r.push(bookCount[i]); }
        classRows.push(r);
      }

      if(window.XLSX){
        const wb = XLSX.utils.book_new();
        const ws1 = XLSX.utils.aoa_to_sheet(studentRows);
        const ws2 = XLSX.utils.aoa_to_sheet(classRows);
        XLSX.utils.book_append_sheet(wb, ws1, 'Students');
        XLSX.utils.book_append_sheet(wb, ws2, 'ClassSummary');
        XLSX.writeFile(wb, 'olympiad_export.xlsx');
      } else {
        // fallback: download two CSVs sequentially
        downloadCSV(studentRows, 'olympiad_students.csv');
        downloadCSV(classRows, 'olympiad_class_summary.csv');
        alert('XLSX library not available — exported CSV files.');
      }
    }
    function downloadCSV(rows, filename){
      const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // start
    init();

  })();
  </script>
</body>
</html>