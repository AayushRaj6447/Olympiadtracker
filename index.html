<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Olympiad Tracker — Exams & Books</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; padding: 18px; background:#f6f7fb; color:#111 }
    .card { max-width:1100px; margin:auto; background:#fff; padding:16px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.06) }
    h1 { margin:0 0 12px 0; font-size:20px }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:10px }
    label { font-weight:600; margin-right:6px }
    select, input[type="number"] { padding:6px; font-size:14px }
    .grid { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px }
    .btn { padding:8px 10px; border:1px solid #cfcfcf; border-radius:6px; background:#fff; cursor:pointer; user-select:none; min-width:90px; text-align:center }
    .btn.active { background:#2e8b57; color:white; border-color:#2e8b57 }
    .section-btn.active { background:#1565c0; color:white; border-color:#1565c0 }
    .controls { margin-top:12px }
    .summary { margin-top:18px; white-space:pre-wrap; background:#fbfbff; padding:10px; border-radius:6px; border:1px solid #e5e7f0; }
    table.summary-table { width:100%; border-collapse:collapse; margin-top:10px }
    table.summary-table th, table.summary-table td { border:1px solid #ddd; padding:6px; text-align:center; font-size:13px }
    .legend { margin-top:10px; font-size:13px; color:#444 }
    .small { font-size:12px; color:#666 }
    .actions { margin-top:12px; display:flex; gap:8px; flex-wrap:wrap }
  </style>
</head>
<body>
  <div class="card">
    <h1>Olympiad Tracker — Exams & Books</h1>

    <div class="row">
      <label for="classSelect">Class</label>
      <select id="classSelect"></select>

      <label for="rollInput">Roll No</label>
      <input id="rollInput" type="number" min="1" max="250" placeholder="(type digits anywhere)" />

      <label>Section</label>
      <div id="sectionButtons" class="grid">
        <!-- A..E will be generated -->
      </div>
      <div class="small">Shortcuts: <strong>Shift+1..8</strong> = Exams, <strong>Q W E R T Y U I</strong> = Books, <strong>Z/X/C/V/B</strong> = Section A–E, digits = roll number</div>
    </div>

    <div>
      <h3 style="margin:8px 0 4px 0">Exams (₹150 each) — use <strong>Shift + 1..8</strong></h3>
      <div id="examButtons" class="grid"></div>
    </div>

    <div>
      <h3 style="margin:8px 0 4px 0">Books (₹100 each, Reasoning ₹250) — keys: <strong>Q W E R T Y U I</strong></h3>
      <div id="bookButtons" class="grid"></div>
    </div>

    <div class="controls row">
      <button id="prevBtn" class="btn">← Previous</button>
      <button id="nextBtn" class="btn">Next →</button>
      <button id="clearBtn" class="btn">Clear Current</button>
      <button id="resetBtn" class="btn">Reset All</button>
      <button id="exportBtn" class="btn">Export Excel/CSV</button>
    </div>

    <div class="summary" id="summaryBox">
      Loading summary...
    </div>

    <div class="legend">
      Notes: Roll numbers are not auto-filled. If a student has exams selected but no books, they are still recorded. Up to 250 students per class.
    </div>
  </div>

  <!-- XLSX fallback: if online this will generate .xlsx; if offline CSV fallback is available -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
  (function(){
    // CONFIG
    const SUBJECTS = ["GK","English","Science","Maths","Computer","Social Studies","Hindi","Reasoning"];
    const MAX_STUDENTS = 250;
    const EXAM_FEE = 150;
    const BOOK_PRICE_DEFAULT = 100;
    const BOOK_PRICE_REASONING = 250;

    // DOM
    const classSelect = document.getElementById('classSelect');
    const rollInput = document.getElementById('rollInput');
    const examButtonsDiv = document.getElementById('examButtons');
    const bookButtonsDiv = document.getElementById('bookButtons');
    const sectionButtonsDiv = document.getElementById('sectionButtons');
    const summaryBox = document.getElementById('summaryBox');

    // Data structure: data[classNumber][studentNumber] = { exams: ['GK',...], books: [...], section: 'A'|'B'.., roll: '12' }
    let data = JSON.parse(localStorage.getItem('olympiadData') || '{}');

    let currentClass = 1;
    let currentStudent = 1;
    let currentSection = null;

    // initialize UI
    function init(){
      // classes 1..10
      for(let i=1;i<=10;i++){
        const opt = document.createElement('option');
        opt.value = i; opt.textContent = 'Class ' + i;
        classSelect.appendChild(opt);
      }
      classSelect.value = currentClass;
      classSelect.addEventListener('change', e=>{
        currentClass = parseInt(e.target.value);
        currentStudent = 1;
        loadStudent();
        renderSummary();
      });

      // sections A..E
      ['A','B','C','D','E'].forEach(s => {
        const b = document.createElement('button');
        b.className = 'btn section-btn';
        b.textContent = s;
        b.dataset.section = s;
        b.addEventListener('click', ()=>{ selectSection(s); });
        sectionButtonsDiv.appendChild(b);
      });

      // exam buttons
      SUBJECTS.forEach((sub,i)=>{
        const b = document.createElement('button');
        b.className = 'btn';
        b.textContent = `${sub} (${i+1})`;
        b.dataset.subject = sub;
        b.dataset.index = i;
        b.addEventListener('click', ()=>toggleExamByIndex(i));
        examButtonsDiv.appendChild(b);
      });

      // book buttons
      SUBJECTS.forEach((sub,i)=>{
        const b = document.createElement('button');
        b.className = 'btn';
        b.textContent = sub;
        b.dataset.subject = sub;
        b.dataset.index = i;
        b.addEventListener('click', ()=>toggleBookByIndex(i));
        bookButtonsDiv.appendChild(b);
      });

      // navigation
      document.getElementById('prevBtn').addEventListener('click', prevStudent);
      document.getElementById('nextBtn').addEventListener('click', nextStudent);
      document.getElementById('clearBtn').addEventListener('click', clearCurrent);
      document.getElementById('resetBtn').addEventListener('click', ()=>{ if(confirm('Reset ALL data?')){ data = {}; save(); loadStudent(); renderSummary(); }});
      document.getElementById('exportBtn').addEventListener('click', exportAll);

      // roll Input: when user focuses and edits, update storage
      rollInput.addEventListener('input', ()=>{ saveRoll(); });

      // load first student
      loadStudent();
      renderSummary();

      // keyboard handling
      window.addEventListener('keydown', keyHandler);
    }

    // Helpers: get or create student record
    function getRecord(cls, stu, makeIfMissing = true){
      if(!data[cls]){
        if(!makeIfMissing) return null;
        data[cls] = {};
      }
      if(!data[cls][stu]){
        if(!makeIfMissing) return null;
        data[cls][stu] = { exams: [], books: [], section: null, roll: "" };
      }
      return data[cls][stu];
    }

    function save(){
      localStorage.setItem('olympiadData', JSON.stringify(data));
    }

    // toggles
    function toggleExamByIndex(i){
      const r = getRecord(currentClass, currentStudent);
      const sub = SUBJECTS[i];
      const idx = r.exams.indexOf(sub);
      if(idx === -1) r.exams.push(sub);
      else r.exams.splice(idx,1);
      save(); loadStudent(); renderSummary();
    }
    function toggleBookByIndex(i){
      const r = getRecord(currentClass, currentStudent);
      const sub = SUBJECTS[i];
      const idx = r.books.indexOf(sub);
      if(idx === -1) r.books.push(sub);
      else r.books.splice(idx,1);
      save(); loadStudent(); renderSummary();
    }
    function selectSection(s){
      const r = getRecord(currentClass, currentStudent);
      r.section = s;
      save(); loadStudent(); renderSummary();
    }
    function saveRoll(){
      const val = rollInput.value.trim();
      const r = getRecord(currentClass, currentStudent);
      r.roll = val;
      save(); renderSummary();
    }

    // navigation
    function prevStudent(){ if(currentStudent>1){ currentStudent--; loadStudent(); } }
    function nextStudent(){ if(currentStudent<MAX_STUDENTS){ currentStudent++; loadStudent(); } }
    const MAX_STUDENTS = MAX_STUDENTS_LOCAL();
    function MAX_STUDENTS_LOCAL(){ return (typeof MAX_STUDENTS === 'undefined') ? 250 : MAX_STUDENTS; }
    // Note: above is placeholder; we'll just use MAX_STUDENTS constant defined earlier (250).
    // But easier: set MAX_STUDENTS to 250 now:
    // (we will ignore the earlier wrapper: use const below)
    // Actually rewrite:
    // done in top: const MAX_STUDENTS = 250; but to keep code simple:
    // We'll just use 250 in nextStudent check:
    function nextStudent(){ if(currentStudent < 250){ currentStudent++; loadStudent(); } }

    // But we already defined nextStudent above; to avoid duplicate, define properly:
    // We'll rewrite navigation functions below to be correct.

    // We'll redefine prev/next to avoid confusion.
    function prevStudent(){
      if (currentStudent > 1) {
        currentStudent--;
        loadStudent();
      }
    }
    function nextStudent(){
      if (currentStudent < 250) {
        currentStudent++;
        loadStudent();
      }
    }

    // Clear current
    function clearCurrent(){
      if(data[currentClass] && data[currentClass][currentStudent]){
        delete data[currentClass][currentStudent];
        save(); loadStudent(); renderSummary();
      } else {
        // nothing to clear
      }
    }

    // loading a student into UI
    function loadStudent(){
      // ensure class select shows current
      classSelect.value = currentClass;
      const record = getRecord(currentClass, currentStudent, false);
      // reset UI
      document.querySelectorAll('#examButtons .btn').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('#bookButtons .btn').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('#sectionButtons .section-btn').forEach(b=>b.classList.remove('active'));
      rollInput.value = '';
      currentSection = null;

      if(record){
        // exams
        record.exams.forEach(sub=>{
          const btn = Array.from(examButtonsDiv.children).find(x => x.dataset.subject === sub);
          if(btn) btn.classList.add('active');
        });
        // books
        record.books.forEach(sub=>{
          const btn = Array.from(bookButtonsDiv.children).find(x => x.dataset.subject === sub);
          if(btn) btn.classList.add('active');
        });
        // section
        if(record.section){
          currentSection = record.section;
          const secBtn = Array.from(sectionButtonsDiv.children).find(x => x.dataset.section === record.section);
          if(secBtn) secBtn.classList.add('active');
        }
        // roll
        if(record.roll) rollInput.value = record.roll;
      }
      // show position
      document.getElementById('studentInfo')?.remove(); // remove old
      const info = document.createElement('div');
      info.id = 'studentInfo';
      info.style.marginTop = '6px';
      info.innerText = `Class ${currentClass} — Student ${currentStudent}`;
      // attach if not present
      if(document.querySelector('.controls')) {
        // nothing
      } else {
        // place info below navigation - but simpler: append to card bottom
      }
      // update summary
      renderSummary();
    }

    // summary: class-wise per-subject counts for both exams and books + money columns
    function renderSummary(){
      // Prepare class-wise matrix
      const classesPresent = Object.keys(data).sort((a,b)=>Number(a)-Number(b));
      let html = '';
      if(classesPresent.length === 0){
        summaryBox.innerText = 'No data yet.';
        return;
      }

      // Table header
      html += '<table class="summary-table"><tr><th>Class</th>';
      SUBJECTS.forEach(s => { html += `<th>${s} (Exam)</th><th>${s} (Book)</th>`; });
      html += '<th>Exam ₹</th><th>Book ₹</th><th>Total ₹</th></tr>';

      let grandExam = 0, grandBook = 0, grandTotal = 0;
      for(let cls of classesPresent){
        // counts per subject
        const examCount = SUBJECTS.map(()=>0);
        const bookCount = SUBJECTS.map(()=>0);
        let examRevenue = 0, bookRevenue = 0;

        for(const stu in data[cls]){
          const rec = data[cls][stu];
          // handle if stored as booleans arrays or as names
          const recExams = Array.isArray(rec.exams) ? rec.exams : [];
          const recBooks = Array.isArray(rec.books) ? rec.books : [];

          recExams.forEach(sub => {
            const idx = SUBJECTS.indexOf(sub);
            if(idx>=0){ examCount[idx]++; examRevenue += EXAM_FEE; }
          });
          recBooks.forEach(sub => {
            const idx = SUBJECTS.indexOf(sub);
            if(idx>=0){ bookCount[idx]++; bookRevenue += (sub === 'Reasoning' ? BOOK_PRICE_REASONING : BOOK_PRICE_DEFAULT); }
          });
        }
        const classTotal = examRevenue + bookRevenue;
        grandExam += examRevenue; grandBook += bookRevenue; grandTotal += classTotal;

        html += `<tr><td>Class ${cls}</td>`;
        for(let i=0;i<SUBJECTS.length;i++){
          html += `<td>${examCount[i]}</td><td>${bookCount[i]}</td>`;
        }
        html += `<td>₹${examRevenue}</td><td>₹${bookRevenue}</td><td>₹${classTotal}</td></tr>`;
      }

      // Grand totals row
      html += `<tr style="font-weight:700"><td>Grand Total</td>`;
      // we won't show per-subject grand columns here to keep it simple; show blanks for those columns
      for(let i=0;i<SUBJECTS.length;i++) html += `<td></td><td></td>`;
      html += `<td>₹${grandExam}</td><td>₹${grandBook}</td><td>₹${grandTotal}</td></tr>`;

      html += '</table>';
      summaryBox.innerHTML = html;
    }

    // keyboard handler
    function keyHandler(e){
      // If user is focused inside an input other than rollInput, skip
      const active = document.activeElement;
      const activeTag = active && active.tagName ? active.tagName.toUpperCase() : null;
      // If user typed inside any other input or textarea, don't hijack
      if(activeTag === 'INPUT' && active !== rollInput) return;
      if(activeTag === 'TEXTAREA') return;

      const key = e.key;

      // Roll-number entry: digits WITHOUT Shift -> append to roll input, unless the roll input is focused (then default)
      if(/^[0-9]$/.test(key) && !e.shiftKey){
        // if rollInput is focused, let default behavior happen
        if(document.activeElement !== rollInput){
          e.preventDefault();
          // append digit
          rollInput.value = (rollInput.value === null) ? key : String(rollInput.value) + key;
          saveRoll();
        }
        return;
      }

      // Backspace when not focused on roll input: delete last digit
      if(key === 'Backspace' && document.activeElement !== rollInput){
        e.preventDefault();
        rollInput.value = String(rollInput.value || '');
        rollInput.value = rollInput.value.slice(0, -1);
        saveRoll();
        return;
      }

      // Arrow navigation
      if(key === 'ArrowRight'){ e.preventDefault(); nextStudent(); return; }
      if(key === 'ArrowLeft'){ e.preventDefault(); prevStudent(); return; }

      // Exams: require Shift + number 1..8
      if(e.shiftKey && /^[1-8]$/.test(key)){
        e.preventDefault();
        const idx = Number(key) - 1;
        toggleExamByIndex(idx);
        return;
      }

      // Books: Q W E R T Y U I
      const bookKeyOrder = ['Q','W','E','R','T','Y','U','I'];
      const up = key.toUpperCase();
      const bidx = bookKeyOrder.indexOf(up);
      if(bidx >= 0){
        e.preventDefault();
        toggleBookByIndex(bidx);
        return;
      }

      // Sections: Z X C V B -> A..E
      const sectionMap = { 'Z':'A','X':'B','C':'C','V':'D','B':'E' };
      if(sectionMap[up]){
        e.preventDefault();
        selectSection(sectionMap[up]);
        return;
      }
    }

    // Export function: creates XLSX using library if present, else CSV fallback
    function exportAll(){
      // Build header
      const header = [
        "Class", "StudentNumber", "Section", "Roll", "ExamList", "BookList", "ExamCost", "BookCost", "Total"
      ];
      // add per-subject two columns each
      SUBJECTS.forEach(s=>{
        header.push(`${s} (Exam)`);
        header.push(`${s} (Book)`);
      });

      const rows = [header];

      for(const cls of Object.keys(data).sort((a,b)=>Number(a)-Number(b))){
        for(const stu of Object.keys(data[cls]).sort((a,b)=>Number(a)-Number(b))){
          const rec = data[cls][stu];
          const exams = Array.isArray(rec.exams) ? rec.exams : [];
          const books = Array.isArray(rec.books) ? rec.books : [];
          const examCost = (exams.length || 0) * EXAM_FEE;
          const bookCost = (books.reduce((sum, sub) => sum + (sub === 'Reasoning' ? BOOK_PRICE_REASONING : BOOK_PRICE_DEFAULT), 0) || 0);
          const total = examCost + bookCost;
          const row = [cls, stu, rec.section || '', rec.roll || '', exams.join(', '), books.join(', '), examCost, bookCost, total];
          // per-subject flags
          SUBJECTS.forEach(s=>{
            row.push(exams.includes(s) ? 1 : 0);
            row.push(books.includes(s) ? 1 : 0);
          });
          rows.push(row);
        }
      }

      // try XLSX
      if(window.XLSX){
        const ws = XLSX.utils.aoa_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Olympiad");
        XLSX.writeFile(wb, "olympiad_export.xlsx");
      } else {
        // fallback CSV
        const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'olympiad_export.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
    }

    // Start
    init();

    // small fix: show first student number label in UI by adding a small info line (not required)
    const infoDIV = document.createElement('div');
    infoDIV.style.marginTop = '8px';
    infoDIV.id = 'studentPosition';
    document.querySelector('.card').appendChild(infoDIV);
    function updatePosition(){
      document.getElementById('studentPosition').innerText = `Class ${currentClass} • Student ${currentStudent}`;
    }
    // wrap loadStudent to update position
    const originalLoad = loadStudent;
    loadStudent = function(){
      // call original loadStudent code defined earlier
      // but to avoid confusion, re-run logic here:
      // Clear UI:
      document.querySelectorAll('#examButtons .btn').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('#bookButtons .btn').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('#sectionButtons .section-btn').forEach(b=>b.classList.remove('active'));
      rollInput.value = '';
      currentSection = null;
      const record = getRecord(currentClass, currentStudent, false);
      if(record){
        record.exams.forEach(sub => {
          const btn = Array.from(examButtonsDiv.children).find(x => x.dataset.subject === sub);
          if(btn) btn.classList.add('active');
        });
        record.books.forEach(sub => {
          const btn = Array.from(bookButtonsDiv.children).find(x => x.dataset.subject === sub);
          if(btn) btn.classList.add('active');
        });
        if(record.section){
          const secBtn = Array.from(sectionButtonsDiv.children).find(x => x.dataset.section === record.section);
          if(secBtn) { secBtn.classList.add('active'); currentSection = record.section; }
        }
        if(record.roll) rollInput.value = record.roll;
      }
      updatePosition();
      renderSummary();
    };

    // bind previously used DOM elements to variables used in redefined functions
    const examButtonsDiv = examButtonsDiv || document.getElementById('examButtons');
    const bookButtonsDiv = bookButtonsDiv || document.getElementById('bookButtons');

    // End of IIFE
  })();
  </script>
</body>
</html>