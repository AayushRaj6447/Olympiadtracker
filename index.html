<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Olympiad Tracker</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    select, button {
      margin: 5px;
      padding: 5px 10px;
    }
    .grid {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 10px;
    }
    .subject-btn {
      padding: 8px 12px;
      cursor: pointer;
      border: 1px solid #aaa;
      border-radius: 4px;
    }
    .selected {
      background-color: #4caf50;
      color: white;
    }
    .section {
      margin-bottom: 20px;
    }
    .summary {
      white-space: pre-wrap;
      background: #f1f1f1;
      padding: 10px;
      border-radius: 5px;
    }
  </style>
</head>
<body>

  <h1>Olympiad Tracker</h1>

  <div class="section">
    <label for="classSelector">Select Class:</label>
    <select id="classSelector">
      <option value="I">Class I</option>
      <option value="II">Class II</option>
      <option value="III">Class III</option>
      <option value="IV">Class IV</option>
      <option value="V">Class V</option>
      <option value="VI">Class VI</option>
      <option value="VII">Class VII</option>
      <option value="VIII">Class VIII</option>
      <option value="IX">Class IX</option>
      <option value="X">Class X</option>
    </select>

    <button onclick="prevStudent()">‚Üê Previous</button>
    <button onclick="nextStudent()">Next ‚Üí</button>
    <span id="studentIdDisplay"></span>
  </div>

  <div class="section">
    <h3>Exam Selection (‚Çπ150/subject)</h3>
    <div id="examButtons" class="grid"></div>

    <h3>Book Selection (‚Çπ100/book, Reasoning ‚Çπ250)</h3>
    <div id="bookButtons" class="grid"></div>
  </div>

  <div class="section">
    <button onclick="downloadExcel()">üì§ Export to Excel</button>
    <button onclick="resetStudent()">Clear Current Student</button>
  </div>

  <div class="section">
    <h3>Live Summary</h3>
    <div id="summary" class="summary">No data yet.</div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    const subjects = ["GK", "English", "Science", "Maths", "Computer", "Social", "Hindi", "Reasoning"];
    const classSelector = document.getElementById("classSelector");
    let currentClass = classSelector.value;
    let currentIndex = 1;
    const maxStudents = 250;

    const data = JSON.parse(localStorage.getItem("olympiadData") || "{}");

    classSelector.addEventListener("change", () => {
      currentClass = classSelector.value;
      currentIndex = 1;
      render();
    });

    function getId() {
      return `${currentClass}_${currentIndex}`;
    }

    function ensureData() {
      if (!data[currentClass]) data[currentClass] = {};
      if (!data[currentClass][getId()]) data[currentClass][getId()] = { exams: [], books: [] };
    }

    function render() {
      document.getElementById("studentIdDisplay").textContent = `Student: ${getId()}`;
      ensureData();

      const examDiv = document.getElementById("examButtons");
      const bookDiv = document.getElementById("bookButtons");
      examDiv.innerHTML = "";
      bookDiv.innerHTML = "";

      subjects.forEach((subj, idx) => {
        const examBtn = document.createElement("button");
        examBtn.textContent = subj;
        examBtn.className = "subject-btn";
        if (data[currentClass][getId()].exams.includes(subj)) examBtn.classList.add("selected");
        examBtn.onclick = () => toggleSubject("exams", subj);
        examDiv.appendChild(examBtn);

        const bookBtn = document.createElement("button");
        bookBtn.textContent = subj;
        bookBtn.className = "subject-btn";
        if (data[currentClass][getId()].books.includes(subj)) bookBtn.classList.add("selected");
        bookBtn.onclick = () => toggleSubject("books", subj);
        bookDiv.appendChild(bookBtn);
      });

      updateSummary();
    }

    function toggleSubject(type, subj) {
      ensureData();
      const list = data[currentClass][getId()][type];
      const i = list.indexOf(subj);
      if (i === -1) list.push(subj);
      else list.splice(i, 1);
      save();
      render();
    }

    function prevStudent() {
      if (currentIndex > 1) {
        currentIndex--;
        render();
      }
    }

    function nextStudent() {
      if (currentIndex < maxStudents) {
        currentIndex++;
        render();
      }
    }

    function resetStudent() {
      if (confirm("Clear selections for current student?")) {
        delete data[currentClass][getId()];
        save();
        render();
      }
    }

    function save() {
      localStorage.setItem("olympiadData", JSON.stringify(data));
    }

    function updateSummary() {
      let summary = "";
      let grandTotal = 0;
      for (const cls in data) {
        summary += `Class ${cls}:\n`;
        const subjectCounts = {};
        let examTotal = 0, bookTotal = 0, students = Object.keys(data[cls]).length;

        subjects.forEach(s => subjectCounts[s] = { exam: 0, book: 0 });

        for (const student in data[cls]) {
          const record = data[cls][student];
          record.exams.forEach(s => subjectCounts[s].exam++);
          record.books.forEach(s => subjectCounts[s].book++);

          examTotal += record.exams.length * 150;
          record.books.forEach(b => bookTotal += (b === "Reasoning" ? 250 : 100));
        }

        subjects.forEach(s => {
          const e = subjectCounts[s].exam;
          const b = subjectCounts[s].book;
          if (e || b) summary += `  ${s} ‚Üí Exams: ${e}, Books: ${b}\n`;
        });

        const total = examTotal + bookTotal;
        grandTotal += total;
        summary += `  Students: ${students}, Exam ‚Çπ${examTotal}, Book ‚Çπ${bookTotal}, Total ‚Çπ${total}\n\n`;
      }
      summary += `Grand Total: ‚Çπ${grandTotal}`;
      document.getElementById("summary").textContent = summary || "No data yet.";
    }

    function downloadExcel() {
      const rows = [["Class", "Student ID", "Exam Subjects", "Book Subjects", "Exam ‚Çπ", "Book ‚Çπ", "Total ‚Çπ"]];
      for (const cls in data) {
        for (const student in data[cls]) {
          const record = data[cls][student];
          const examCost = record.exams.length * 150;
          const bookCost = record.books.reduce((acc, b) => acc + (b === "Reasoning" ? 250 : 100), 0);
          const total = examCost + bookCost;
          rows.push([cls, student, record.exams.join(", "), record.books.join(", "), examCost, bookCost, total]);
        }
      }
      const sheet = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, sheet, "OlympiadData");
      XLSX.writeFile(wb, "olympiad_data.xlsx");
    }

    document.addEventListener("keydown", (e) => {
      const key = e.key.toUpperCase();
      const examKeys = "12345678";
      const bookKeys = "QWERTYUIO";

      if (examKeys.includes(key)) {
        const idx = examKeys.indexOf(key);
        toggleSubject("exams", subjects[idx]);
      }

      if (bookKeys.includes(key)) {
        const idx = bookKeys.indexOf(key);
        toggleSubject("books", subjects[idx]);
      }

      if (key === "ARROWRIGHT") nextStudent();
      if (key === "ARROWLEFT") prevStudent();
    });

    render();
  </script>

</body>
</html>